<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Shuttle League — Single File</title>

  <!-- Tailwind CDN (fine for dev; switch to CLI for prod) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            base: '#0B0E14',
            neon: { emerald: '#00F5C8', blue: '#45A3FF' }
          },
          boxShadow: {
            glow: '0 0 30px rgba(0,245,200,.25)',
            soft: '0 10px 30px rgba(0,0,0,.35)'
          },
          fontFamily: {
            manrope: ['Manrope','system-ui'],
            outfit: ['Outfit','system-ui']
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
    html, body { height: 100%; background:#0B0E14; }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(255,255,255,.08); }
    .neon { box-shadow: 0 0 0 1px rgba(69,163,255,.25), 0 0 20px rgba(0,245,200,.25); }
    .gradient-bg { background:
      radial-gradient(1200px 400px at 50% -10%, rgba(0,245,200,.15), transparent),
      radial-gradient(800px 400px at 100% 10%, rgba(69,163,255,.12), transparent),
      #0B0E14; }
    .tab-active { color:#00F5C8 }
    .safe-top { padding-top: max(8px, env(safe-area-inset-top)); }
    .safe-bottom { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    .fade-slide-in { animation: fsIn .35s cubic-bezier(.2,.8,.2,1); }
    @keyframes fsIn { from { opacity:0; transform: translateY(8px) } to { opacity:1; transform: translateY(0) } }
    .bounce { animation: bnc .5s cubic-bezier(.2,.8,.2,1); }
    @keyframes bnc { 0%{transform:scale(.98)} 60%{transform:scale(1.02)} 100%{transform:scale(1)} }
    button:disabled { opacity:.5; cursor:not-allowed }
  </style>

  <!-- Firebase v10 CDN (modular) -->
  <script type="module" id="firebase-init">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set, update, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // Exact config + correct Realtime Database URL
    const firebaseConfig = {
      apiKey: "AIzaSyArgNsg5frTJ8ptzhxNR9iUXJGmyBXGDes",
      authDomain: "shuttle-ea481.firebaseapp.com",
      databaseURL: "https://shuttle-ea481-default-rtdb.firebaseio.com", // <-- verified working
      projectId: "shuttle-ea481",
      storageBucket: "shuttle-ea481.firebasestorage.app",
      messagingSenderId: "984382793220",
      appId: "1:984382793220:web:4605b2608bf2d8f45db751"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    // Pass URL explicitly so the SDK doesn't guess a wrong regional host
    const db   = getDatabase(app, firebaseConfig.databaseURL);

    // Expose for other inline scripts
    window.fb = { app, auth, db, ref, onValue, set, update, push, serverTimestamp };

    // ---------- AUTH READY GATE + STATUS ----------
    let resolveAuthReady, rejectAuthReady;
    const authReady = new Promise((res, rej) => { resolveAuthReady = res; rejectAuthReady = rej; });
    window.authReady = authReady;

    const setStatus = (t, err=false) => {
      const el = document.getElementById('status');
      if (!el) return;
      el.textContent = t;
      el.className = "text-xs " + (err ? "text-red-400" : "text-neon-emerald");
    };

    onAuthStateChanged(auth, async (u) => {
      if (!u) {
        try {
          await signInAnonymously(auth);
        } catch (e) {
          console.error("Anonymous sign-in failed:", e);
          setStatus("Auth failed: enable Anonymous sign-in & add localhost/127.0.0.1 to Authorized domains.", true);
          rejectAuthReady?.(e);
        }
        return;
      }

      resolveAuthReady?.(u);
      setStatus("Signed in (anonymous)");

      // Healthcheck write — validates DB URL + rules
      try {
        await set(ref(db, "__healthcheck"), { t: Date.now() });
        setStatus("DB OK");
      } catch (e) {
        console.error("DB write failed:", e);
        setStatus("DB reachable but write blocked — set Realtime DB rules to auth != null for dev.", true);
      }

      // Hydrate session from URL if present
      const params = new URLSearchParams(location.search);
      const sess = params.get('session');
      if (sess) selectSession(sess);
    });

    // Helper for click handlers
    window.getUid = async () => auth.currentUser?.uid ?? (await authReady).uid;

    // ---------- LOCAL CACHE ----------
    const LSKEY = "shuttle.cache";
    function cacheGet(code){ try{ return JSON.parse(localStorage.getItem(LSKEY)||"{}")[code]||null }catch{ return null } }
    function cacheSet(code,data){ try{ const obj=JSON.parse(localStorage.getItem(LSKEY)||"{}"); obj[code]=data; localStorage.setItem(LSKEY,JSON.stringify(obj)); }catch{} }
    window.cache = { get: cacheGet, set: cacheSet };

    // ---------- DATA BINDING ----------
    let unsub = null;
    window.selectSession = function(code){
      const codeInput = document.getElementById('code');
      if (codeInput) codeInput.value = code;
      history.replaceState({}, '', `?session=${code}`);
      const bindEl = document.getElementById('bind');
      bindEl.textContent = code;

      if (unsub) unsub();
      const r = ref(db, `sessions/${code}`);
      unsub = onValue(r, (snap) => {
        const data = snap.val() || null;
        cacheSet(code, data);
        renderAll(data);
      });
      renderAll(cacheGet(code)); // optimistic render from cache
    };

    // ---------- HELPERS ----------
    window.randCode = () => Math.floor(100000 + Math.random()*900000).toString();

    window.ensurePlayer = async (code, uid, name="Player") => {
      await set(ref(db, `sessions/${code}/players/${uid}`), {
        name, isComing: true, createdAt: serverTimestamp()
      });
    };

    window.toggleComing = async (code, uid, isComing) => {
      await update(ref(db, `sessions/${code}/players/${uid}`), { isComing: !isComing });
    };

    window.setLocked = async (code, locked) => {
      await update(ref(db, `sessions/${code}/meta`), { locked });
    };

    window.shuffleTeams = async (code, data) => {
      await set(ref(db, `sessions/${code}/teams`), null);
      const players = Object.entries(data?.players||{}).filter(([,p])=>p.isComing).map(([uid,p])=>({uid,name:p.name}));
      const shuffled = players.map(p=>[Math.random(),p]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
      const used = new Set();
      const pairs = [];
      for (let i=0;i<shuffled.length-1;i++){
        const a = shuffled[i]; if (used.has(a.uid)) continue;
        let partner = null;
        for (let j=i+1;j<shuffled.length;j++){
          const b = shuffled[j]; if (!used.has(b.uid)) { partner=b; break; }
        }
        if (partner){ used.add(a.uid); used.add(partner.uid); pairs.push([a.uid, partner.uid]); }
      }
      const leftovers = shuffled.filter(p=>!used.has(p.uid)).map(p=>p.uid);
      for (const pr of pairs) await push(ref(db, `sessions/${code}/teams`), { players: pr });
      if (leftovers.length) await push(ref(db, `sessions/${code}/teams`), { players: [leftovers[0], null], sub:true });
    };

    function roundRobin(teamIds){
      const n = teamIds.length; if (n<2) return [];
      const arr = teamIds.slice(); if (n%2===1) arr.push(null);
      const size = arr.length, half=size/2, rounds=[];
      for(let r=0;r<size-1;r++){
        const matches=[];
        for(let i=0;i<half;i++){
          const a=arr[i], b=arr[size-1-i];
          if(a!==null && b!==null) matches.push([a,b]);
        }
        rounds.push(matches);
        const fixed = arr[0];
        const rotated = [fixed, ...arr.slice(-1), ...arr.slice(1,-1)];
        for(let i=0;i<size;i++) arr[i]=rotated[i];
      }
      return rounds;
    }

    window.genFixtures = async (code, data) => {
      await set(ref(db, `sessions/${code}/matches`), null);
      const teams = Object.keys(data?.teams||{});
      const courts = data?.meta?.courts || 2;
      const rounds = roundRobin(teams);
      for (let r=0;r<rounds.length;r++){
        const matches = rounds[r];
        for (let i=0;i<matches.length;i++){
          const [A,B] = matches[i];
          await push(ref(db, `sessions/${code}/matches`), {
            round: r+1, court: (i % courts) + 1, teamA: A, teamB: B,
            status: "pending", aScore: 0, bScore: 0
          });
        }
      }
    };

    window.setMatchStatus = (code, id, status) =>
      update(ref(db, `sessions/${code}/matches/${id}`), { status });

    window.scoreOp = (code, data, id, side, delta) => {
      const m = data.matches[id];
      const key = side==='A' ? 'aScore' : 'bScore';
      const next = Math.max(0, (m[key]||0) + delta);
      const payload = { [key]: next };
      const a = side==='A' ? next : (m.aScore||0);
      const b = side==='B' ? next : (m.bScore||0);
      if ((a>=21 || b>=21) && Math.abs(a-b) >= 2) payload.status='finished';
      return update(ref(db, `sessions/${code}/matches/${id}`), payload);
    };

    window.exportCSV = (rows, filename="standings.csv") => {
      const esc = v => `"${String(v??'').replaceAll('"','""')}"`;
      const csv = rows.map(r => r.map(esc).join(',')).join('\n');
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href:url, download:filename });
      a.click(); URL.revokeObjectURL(url);
    };

    // Render pipeline
    window.renderAll = (data) => {
      renderAttendance(data);
      renderTeams(data);
      renderFixtures(data);
      renderLive(data);
      renderLeaderboard(data);
      document.getElementById('live-dot').className =
        (Object.values(data?.matches||{}).some(m=>m.status==='live')
          ? 'text-neon-emerald'
          : 'text-white/60');
    };
  </script>
</head>
<body class="text-white font-outfit gradient-bg min-h-screen">
  <!-- Header -->
  <header class="safe-top px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <svg width="20" height="20" viewBox="0 0 24 24" class="text-neon-blue"><circle cx="12" cy="12" r="10" fill="#45A3FF"/></svg>
      <span class="font-extrabold">Shuttle League</span>
    </div>
    <div class="text-xs opacity-80 flex items-center gap-2">
      <span id="online-label">Live</span>
      <span id="live-dot" class="text-white/60">●</span>
      <span id="status" class="text-xs text-white/60">Signing in…</span>
    </div>
  </header>

  <!-- Tabs -->
  <main class="max-w-md mx-auto pb-28">
    <!-- Join -->
    <section id="tab-join" class="px-4 fade-slide-in">
      <div class="glass neon rounded-3xl p-4 shadow-soft mt-2">
        <div class="text-lg font-extrabold mb-2">Create or Join a Night</div>
        <div class="grid gap-2">
          <input id="name" placeholder="Your name" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none">
          <div class="grid grid-cols-3 gap-2">
            <input id="code" inputmode="numeric" maxlength="6" placeholder="Session code" class="col-span-2 bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none">
            <button id="btn-join" class="bg-neon-emerald/20 border border-neon-emerald/40 rounded-xl px-3 py-3 font-bold">Join</button>
          </div>
          <button id="btn-create" class="w-full bg-neon-blue/20 border border-neon-blue/40 rounded-xl px-4 py-3 font-extrabold">Create New (6-digit)</button>
          <div class="text-[11px] opacity-70">Session: <span id="bind">—</span></div>
          <div id="qr" class="mt-2 flex flex-col items-center gap-2"></div>
        </div>
      </div>
    </section>

    <!-- Attendance -->
    <section id="tab-attendance" class="hidden px-4 fade-slide-in">
      <div class="glass neon rounded-3xl p-4 shadow-soft mt-2">
        <div class="flex items-center justify-between">
          <div class="font-extrabold">Attendance</div>
          <div class="text-xs opacity-70" id="att-count">0 players</div>
        </div>
        <div id="att-list" class="mt-3 flex flex-col gap-2"></div>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button id="btn-lock" class="bg-neon-emerald/20 border border-neon-emerald/40 rounded-xl px-3 py-2 font-bold">Lock</button>
          <button id="btn-unlock" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 font-bold">Unlock</button>
        </div>
      </div>
    </section>

    <!-- Teams -->
    <section id="tab-teams" class="hidden px-4 fade-slide-in">
      <div class="glass neon rounded-3xl p-4 shadow-soft mt-2">
        <div class="flex items-center justify-between">
          <div class="font-extrabold">Team Generator</div>
          <button id="btn-shuffle" class="bg-neon-blue/20 border border-neon-blue/40 rounded-xl px-3 py-2 font-bold">Shuffle</button>
        </div>
        <div id="teams" class="mt-3 grid gap-2"></div>
      </div>
    </section>

    <!-- Fixtures -->
    <section id="tab-fixtures" class="hidden px-4 fade-slide-in">
      <div class="glass neon rounded-3xl p-4 shadow-soft mt-2">
        <div class="flex items-center justify-between">
          <div class="font-extrabold">Fixture Maker</div>
          <button id="btn-genfix" class="bg-neon-emerald/20 border border-neon-emerald/40 rounded-xl px-3 py-2 font-bold">Generate</button>
        </div>
        <div id="matches" class="mt-3 grid gap-2"></div>
      </div>
    </section>

    <!-- Live + Leaderboard -->
    <section id="tab-live" class="hidden px-4 fade-slide-in">
      <div id="live-list" class="grid gap-3 mt-2"></div>
      <div class="glass neon rounded-3xl p-4 shadow-soft mt-3">
        <div class="flex items-center justify-between">
          <div class="font-extrabold">Leaderboard</div>
          <button id="btn-csv" class="text-xs bg-white/5 border border-white/10 rounded-xl px-3 py-2">Export CSV</button>
        </div>
        <div id="board" class="mt-3 flex flex-col gap-2"></div>
      </div>
    </section>
  </main>

  <!-- Bottom Nav -->
  <nav class="safe-bottom fixed bottom-0 left-0 right-0">
    <div class="mx-auto max-w-md">
      <div class="glass neon rounded-t-3xl flex items-center justify-between px-4 py-2">
        <button data-tab="join" class="tab w-full flex flex-col items-center py-2"><span class="text-sm">Join</span></button>
        <button data-tab="attendance" class="tab w-full flex flex-col items-center py-2"><span class="text-sm">Attendance</span></button>
        <button data-tab="teams" class="tab w-full flex flex-col items-center py-2"><span class="text-sm">Teams</span></button>
        <button data-tab="fixtures" class="tab w-full flex flex-col items-center py-2"><span class="text-sm">Fixtures</span></button>
        <button data-tab="live" class="tab w-full flex flex-col items-center py-2"><span class="text-sm">Live</span></button>
      </div>
    </div>
  </nav>

  <!-- App logic -->
  <script>
    // Online indicator
    const onlineLabel = document.getElementById('online-label');
    const setOnline = () => onlineLabel.textContent = navigator.onLine ? 'Live' : 'Offline';
    addEventListener('online', setOnline); addEventListener('offline', setOnline); setOnline();

    // Simple tab router
    const tabs = ['join','attendance','teams','fixtures','live'];
    function showTab(t){
      for (const id of tabs){
        document.getElementById('tab-'+id).classList.toggle('hidden', id!==t);
      }
      document.querySelectorAll('button.tab').forEach(b=>{
        const active = b.dataset.tab===t; b.classList.toggle('tab-active', active);
      });
      localStorage.setItem('shuttle.tab', t);
    }
    document.querySelectorAll('button.tab').forEach(b=>b.addEventListener('click', ()=>showTab(b.dataset.tab)));
    showTab(localStorage.getItem('shuttle.tab') || 'join');

    // Join/Create handlers
    const nameEl   = document.getElementById('name');
    const codeEl   = document.getElementById('code');
    const btnCreate= document.getElementById('btn-create');
    const btnJoin  = document.getElementById('btn-join');

    // Disable until auth is ready
    btnCreate.disabled = btnJoin.disabled = true;
    (window.authReady ?? Promise.resolve()).then(()=>{
      btnCreate.disabled = btnJoin.disabled = false;
    }).catch(()=>{ /* keep disabled on auth failure */ });

    document.getElementById('btn-create').onclick = async () => {
      try {
        const code = randCode();
        codeEl.value = code;
        const uid = await getUid();
        await fb.set(fb.ref(fb.db, `sessions/${code}/meta`), { creatorUid: uid, locked:false, courts:2, createdAt: fb.serverTimestamp() });
        await ensurePlayer(code, uid, nameEl.value||'Player');
        selectSession(code);
        flashQR(code);
        showTab('attendance');
      } catch (e) {
        alert('Cannot create session: authentication/database not ready.\nFix Firebase settings and reload.');
      }
    };

    document.getElementById('btn-join').onclick = async () => {
      try {
        const code = (codeEl.value||'').replace(/[^0-9]/g,'');
        if (!code || code.length<6) { alert('Enter 6-digit code'); return; }
        const uid = await getUid();
        await ensurePlayer(code, uid, nameEl.value||'Player');
        selectSession(code);
        flashQR(code);
        showTab('attendance');
      } catch (e) {
        alert('Cannot join: authentication/database not ready.\nFix Firebase settings and reload.');
      }
    };

    // QR (external service to avoid bundling a lib)
    function flashQR(code){
      const url = `${location.origin}${location.pathname}?session=${code}`;
      const qr = document.getElementById('qr'); qr.innerHTML='';
      const img = new Image();
      img.src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(url)}&bgcolor=0B0E14&color=00F5C8`;
      img.className = 'rounded-xl bounce'; qr.appendChild(img);
      const p = document.createElement('p'); p.className='text-xs opacity-80 break-all text-center'; p.textContent = url; qr.appendChild(p);
    }

    // Render functions
    function renderAttendance(data){
      const wrap = document.getElementById('att-list'); wrap.innerHTML='';
      const code = codeEl.value;
      const players = Object.entries(data?.players||{});
      document.getElementById('att-count').textContent = `${players.length} players`;
      players.forEach(([uid,p])=>{
        const btn = document.createElement('button');
        btn.className = `w-full text-left bg-white/5 border border-white/10 rounded-xl px-4 py-3 ${p.isComing?'ring-1 ring-[rgba(0,245,200,.5)]':''}`;
        btn.innerHTML = `<div class="flex items-center justify-between">
          <span class="font-semibold">${p.name}</span>
          <span class="text-xs ${p.isComing?'text-neon-emerald':'text-white/50'}">${p.isComing?'✅ Coming':'—'}</span>
        </div>`;
        btn.onclick = ()=>toggleComing(code, uid, p.isComing);
        wrap.appendChild(btn);
      });

      document.getElementById('btn-lock').onclick = ()=>setLocked(code, true);
      document.getElementById('btn-unlock').onclick = ()=>setLocked(code, false);
    }

    function renderTeams(data){
      const wrap = document.getElementById('teams'); wrap.innerHTML='';
      const code = codeEl.value;
      (Object.entries(data?.teams||{})).forEach(([id,t],i)=>{
        const div = document.createElement('div');
        const a = (t.players||[]).map(u => data.players?.[u]?.name || '—').join(' & ');
        div.className = 'bg-white/5 border border-white/10 rounded-xl px-4 py-3 flex items-center justify-between';
        div.innerHTML = `<div class="text-sm">Team ${i+1}</div><div class="text-xs opacity-80">${a}</div>${t.sub?'<span class="text-[10px] text-yellow-300]">(Sub)</span>':''}`;
        wrap.appendChild(div);
      });
      document.getElementById('btn-shuffle').onclick = ()=>shuffleTeams(code, data);
    }

    function renderFixtures(data){
      const wrap = document.getElementById('matches'); wrap.innerHTML='';
      Object.entries(data?.matches||{}).forEach(([id,m])=>{
        const ta = (data.teams?.[m.teamA]?.players||[]).map(u=>data.players?.[u]?.name).join(' & ');
        const tb = (data.teams?.[m.teamB]?.players||[]).map(u=>data.players?.[u]?.name).join(' & ');
        const row = document.createElement('div');
        row.className = 'bg-white/5 border border-white/10 rounded-xl px-4 py-3 flex items-center justify-between';
        row.innerHTML = `<div class="text-xs">R${m.round} • Court ${m.court}</div>
           <div class="text-xs opacity-80">${ta} vs ${tb}</div>
           <div class="text-[10px] ${m.status==='live'?'text-neon-emerald':'text-white/60'}">${m.status}</div>`;
        wrap.appendChild(row);
      });
      const btn = document.getElementById('btn-genfix');
      btn.onclick = ()=>genFixtures(codeEl.value, data);
    }

    function renderLive(data){
      const wrap = document.getElementById('live-list'); wrap.innerHTML='';
      const entries = Object.entries(data?.matches||{}).sort((a,b)=> (a[1].round-b[1].round)||(a[1].court-b[1].court));
      entries.forEach(([id,m])=>{
        const card = document.createElement('div');
        card.className = 'glass neon rounded-3xl p-4 shadow-soft';
        const ta = (data.teams?.[m.teamA]?.players||[]).map(u=>data.players?.[u]?.name).join(' & ');
        const tb = (data.teams?.[m.teamB]?.players||[]).map(u=>data.players?.[u]?.name).join(' & ');
        card.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm font-extrabold">R${m.round} • Court ${m.court}</div>
            <div class="text-[10px] ${m.status==='live'?'text-neon-emerald':'text-white/60'}">${m.status}</div>
          </div>
          <div class="text-xs opacity-80 mb-3">${ta} <span class="opacity-60">vs</span> ${tb}</div>
          <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col items-center gap-2">
              <div class="text-xs opacity-70">Team A</div>
              <div class="flex items-center gap-2">
                <button class="minusA bg-white/5 border border-white/10 rounded-xl px-3 py-2">-</button>
                <div class="scoreA text-4xl font-extrabold">${m.aScore||0}</div>
                <button class="plusA bg-[rgba(0,245,200,.2)] border border-[rgba(0,245,200,.4)] rounded-xl px-3 py-2">+</button>
              </div>
            </div>
            <div class="flex flex-col items-center gap-2">
              <div class="text-xs opacity-70">Team B</div>
              <div class="flex items-center gap-2">
                <button class="minusB bg-white/5 border border-white/10 rounded-xl px-3 py-2">-</button>
                <div class="scoreB text-4xl font-extrabold">${m.bScore||0}</div>
                <button class="plusB bg-[rgba(0,245,200,.2)] border border-[rgba(0,245,200,.4)] rounded-xl px-3 py-2">+</button>
              </div>
            </div>
          </div>
          <div class="mt-3 grid grid-cols-3 gap-2 text-xs">
            <button class="pnd bg-white/5 border border-white/10 rounded-xl px-3 py-2">Pending</button>
            <button class="lv bg-[rgba(0,245,200,.2)] border border-[rgba(0,245,200,.4)] rounded-xl px-3 py-2">Live</button>
            <button class="fin bg-white/5 border border-white/10 rounded-xl px-3 py-2">Finish</button>
          </div>`;
        wrap.appendChild(card);
        card.querySelector('.pnd').onclick = ()=>setMatchStatus(codeEl.value, id, 'pending');
        card.querySelector('.lv').onclick  = ()=>setMatchStatus(codeEl.value, id, 'live');
        card.querySelector('.fin').onclick = ()=>setMatchStatus(codeEl.value, id, 'finished');
        card.querySelector('.plusA').onclick = ()=>scoreOp(codeEl.value, data, id,'A',+1);
        card.querySelector('.minusA').onclick= ()=>scoreOp(codeEl.value, data, id,'A',-1);
        card.querySelector('.plusB').onclick = ()=>scoreOp(codeEl.value, data, id,'B',+1);
        card.querySelector('.minusB').onclick= ()=>scoreOp(codeEl.value, data, id,'B',-1);
      });
    }

    function renderLeaderboard(data){
      const board = document.getElementById('board'); board.innerHTML='';
      const players = Object.entries(data?.players||{});
      const scores = {};
      // wins
      Object.entries(data?.matches||{}).forEach(([id,m])=>{
        if (m.status!=='finished') return;
        const aWin = (m.aScore||0) > (m.bScore||0);
        const aTeam = data.teams?.[m.teamA]?.players||[];
        const bTeam = data.teams?.[m.teamB]?.players||[];
        for (const u of (aWin?aTeam:bTeam)) scores[u] = (scores[u]||0)+2;
      });
      // attendance
      players.forEach(([uid,p])=>{ if (p.isComing) scores[uid]=(scores[uid]||0)+1; });
      const rows = players.map(([uid,p])=>({uid, name:p.name, points:scores[uid]||0})).sort((a,b)=>b.points-a.points);
      rows.forEach((r,i)=>{
        const div = document.createElement('div');
        div.className='bg-white/5 border border-white/10 rounded-xl px-4 py-3 flex items-center justify-between';
        div.innerHTML = `<div class="text-xs opacity-80">#${i+1}</div><div class="font-semibold">${r.name}</div><div class="text-neon-emerald font-bold text-sm">${r.points}</div>`;
        board.appendChild(div);
      });
      document.getElementById('btn-csv').onclick = () =>
        exportCSV([['Rank','Name','Points'], ...rows.map((r,i)=>[i+1, r.name, r.points])]);
    }
  </script>
</body>
</html>
